---
title: "p8106-hw2"
author: "xinran"
date: "3/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = T, message = FALSE}
library(caret)
library(splines)
library(mgcv)
library(tidyverse)
library(ggplot2)
library(patchwork)
library(boot)
```

```{r}
set.seed(1)
```

```{r}
college = read.csv("./data/College.csv") %>% 
  janitor::clean_names()

college_tr=college%>%
  filter(college!="Columbia University")%>%
  select(-college)
# matrix of predictors 
x <- model.matrix(outstate~.,college_tr)[,-1]
# vector of response
y <- college$outstate

featurePlot(x, y, plot = "scatter", labels = c("","Y"), type = c("p"), layout = c(4, 4))
```
## (a) Create scatter plots of response vs. predictors.

```{r,fig.height=12, fig.width=12}
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(.2, .4, .2, .5)
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(.8, .1, .1, 1)
theme1$plot.line$lwd <- 2
theme1$strip.background$col <- rgb(.0, .2, .6, .2)
trellis.par.set(theme1)

featurePlot(x, y, plot = "scatter", labels = c("","Y"), type = c("p"), layout = c(4, 4))
```
## (b) Fit a smoothing spline model using Terminal as the only predictor of Outstate for a range of degrees of freedom, as well as the degree of freedom obtained by generalized crossvalidation, and plot the resulting fits. Describe the results obtained.

```{r}
fit.ss=smooth.spline(college$terminal)

fit.ss$df

terminallims <- range(college$terminal)
terminal.grid <- seq(from = terminallims[1],to = terminallims[2])

pred.ss <- predict(fit.ss,
                   x = terminal.grid)

pred.ss.df <- data.frame(pred = pred.ss$y,
                         terminal = terminal.grid)

p <- ggplot(data = college, aes(x = terminal, y = outstate)) +
     geom_point(color = rgb(.2, .4, .2, .5))
p +
geom_line(aes(x = terminal, y = pred), data = pred.ss.df,
          color = rgb(.8, .1, .1, 1)) + theme_bw()
```
description: There is an increasing, monotonic but non-linear relationship between terminal and outstate.

## (c) Fit a generalized additive model (GAM) using all the predictors. Plot the results and explain your findings.
```{r}
gam.m1 <- gam(outstate~apps+accept+enroll+top10perc+top25perc+f_undergrad+p_undergrad+room_board+books+personal+ph_d+terminal+s_f_ratio+perc_alumni+expend+grad_rate, data = college)

gam.m2 <- gam(outstate~apps+accept+enroll+top10perc+top25perc+f_undergrad+p_undergrad+room_board+books+personal+ph_d+terminal+s_f_ratio+perc_alumni+expend+grad_rate, data = college)

gam.m3 <- gam(outstate~apps+accept+enroll+top10perc+top25perc+f_undergrad+p_undergrad+room_board+books+personal+ph_d+terminal+s_f_ratio+perc_alumni+expend+grad_rate, data = college)

anova(gam.m1, gam.m2, gam.m3, test = "F")
```

```{r}
plot(gam.m2)

vis.gam(gam.m3, view = c("lcavol","lweight"), 
        plot.type = "contour", color = "topo")
```
## (d) Fit a multivariate adaptive regression spline (MARS) model using all the predictors. Report the final model. Present the partial dependence plot of an arbitrary predictor in your final model.
## (e) Based on the above GAM and MARS models, predict the out-of-state tuition of Columbia University.